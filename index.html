<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>LohnCheck Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #0b0e14; --card: #1c2128; --accent: #6366f1; --text: #ffffff; --divider: rgba(255,255,255,0.06); }
        .light-mode { --bg: #f2f2f7; --card: #ffffff; --text: #000000; --divider: rgba(0,0,0,0.08); }
        
        body { 
            background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; 
            transition: 0.3s; padding-bottom: 60px; -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .ios-blur { background: rgba(22, 27, 34, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--divider); }
        .nav-btn { padding: 12px 10px; border-radius: 12px; font-size: 13px; font-weight: 600; flex: 1; text-align: center; border: 1px solid transparent; }
        .nav-btn.active { background: var(--accent); color: white; border-color: rgba(255,255,255,0.1); }
        .card { background: var(--card); border-radius: 20px; border: 1px solid var(--divider); overflow: hidden; }
        
        .calendar-grid { display: grid; grid-template-columns: 60px 1fr 70px; align-items: center; border-bottom: 1px solid var(--divider); padding: 10px 12px; }
        
        .btn-shift { 
            width: 36px; height: 36px; border-radius: 10px; font-size: 12px; font-weight: 800; 
            border: 1px solid var(--divider); background: rgba(255,255,255,0.05); color: var(--text); 
            opacity: 0.4; display: flex; align-items: center; justify-content: center;
            -webkit-user-select: none; user-select: none;
        }
        .btn-shift.active { opacity: 1; background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.4); }
        
        input.hr-edit, select.ios-select { 
            background: rgba(99, 102, 241, 0.1) !important; border: 1px solid rgba(99, 102, 241, 0.3) !important; 
            border-radius: 8px; text-align: center; font-weight: bold; font-size: 15px; color: var(--text); 
            outline: none; height: 36px; width: 100%; -webkit-appearance: none;
        }
        .safe-area { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="safe-area">

    <nav class="ios-blur sticky top-0 z-50 p-4 mb-4">
        <div class="max-w-lg mx-auto flex items-center justify-between gap-3">
            <div class="flex flex-1 gap-1 bg-black/20 p-1 rounded-2xl border border-white/5">
                <button type="button" onclick="switchTab('plan')" id="btn-plan" class="nav-btn active text-white">Plan</button>
                <button type="button" onclick="switchTab('rechner')" id="btn-rechner" class="nav-btn text-gray-400">Lohn</button>
                <button type="button" onclick="switchTab('profil')" id="btn-profil" class="nav-btn text-gray-400">Setup</button>
            </div>
            <button onclick="document.body.classList.toggle('light-mode')" class="w-10 h-10 flex items-center justify-center bg-white/5 rounded-2xl border border-white/10">üåì</button>
        </div>
    </nav>

    <main class="px-3 max-w-lg mx-auto">
        
        <div id="tab-plan" class="space-y-4">
            <div class="flex justify-between items-center px-1">
                <div class="flex gap-2">
                    <select id="monthSelect" onchange="renderCalendar()" class="bg-transparent font-black text-xl text-indigo-400"></select>
                    <select id="yearSelect" onchange="renderCalendar()" class="bg-transparent font-black text-xl text-indigo-400"></select>
                </div>
                <div class="flex gap-2 items-center">
                    <div id="planIst" class="text-[10px] font-bold opacity-50">0h</div>
                    <div id="planSaldo" class="text-[10px] font-bold px-3 py-1 rounded-full">-</div>
                </div>
            </div>
            <div class="card" id="calendarContainer"></div>
        </div>

        <div id="tab-rechner" class="hidden space-y-4">
            <div class="text-center py-8">
                <p class="text-[10px] opacity-40 uppercase font-bold tracking-widest mb-1">Netto-Sch√§tzung</p>
                <h1 id="finalNetto" class="text-6xl font-black tracking-tighter">0,00</h1>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div class="card p-3 text-center"><p class="text-[8px] opacity-50 uppercase mb-1">Nacht</p><p id="statN" class="font-bold text-indigo-400">0h</p></div>
                <div class="card p-3 text-center"><p class="text-[8px] opacity-50 uppercase mb-1">Sonntag</p><p id="statSo" class="font-bold text-red-400">0h</p></div>
                <div class="card p-3 text-center"><p class="text-[8px] opacity-50 uppercase mb-1">Feiertag</p><p id="statFt" class="font-bold text-emerald-400">0h</p></div>
            </div>
            <div class="card p-2">
                <div class="flex justify-between p-3 text-sm border-b border-white/5"><span>Brutto Gesamt</span><span id="bruttoLabel" class="font-bold"></span></div>
                <div class="flex justify-between p-3 text-sm text-emerald-400"><span>Zuschl√§ge</span><span id="taxFreeLabel" class="font-bold"></span></div>
            </div>
            <button onclick="shareWhatsApp()" class="w-full bg-[#25D366] text-black font-extrabold py-4 rounded-2xl shadow-lg">WhatsApp Export</button>
        </div>

        <div id="tab-profil" class="hidden space-y-4">
            <div class="card p-2">
                <div class="flex justify-between p-3 items-center border-b border-white/5"><span>Grundgehalt</span><input type="number" id="tarif" value="4275" oninput="saveAndCalc()" class="hr-edit w-32"></div>
                <div class="flex justify-between p-3 items-center border-b border-white/5"><span>Soll-Stunden</span><input type="number" id="sollstunden" value="167" oninput="saveAndCalc()" class="hr-edit w-32"></div>
                <div class="flex justify-between p-3 items-center"><span>√ú-Std Auszahlung</span><input type="number" id="h_ue" value="0" oninput="saveAndCalc()" class="hr-edit w-32"></div>
            </div>
            <div class="card p-2">
                <div class="flex justify-between p-3 items-center border-b border-white/5"><span>Steuerklasse</span>
                    <select id="st_klasse" onchange="saveAndCalc()" class="ios-select w-32">
                        <option value="1">Klasse 1</option><option value="2">Klasse 2</option><option value="3">Klasse 3</option>
                        <option value="4" selected>Klasse 4</option><option value="5">Klasse 5</option><option value="6">Klasse 6</option>
                    </select>
                </div>
                <div class="flex justify-between p-3 items-center border-b border-white/5"><span>Kinder</span>
                    <select id="kinder" onchange="saveAndCalc()" class="ios-select w-32">
                        <option value="0">0.0</option><option value="0.5">0.5</option><option value="1.0">1.0</option><option value="2.0">2.0</option>
                    </select>
                </div>
                <div class="flex justify-between p-3 items-center"><span>Kirche</span>
                    <select id="kirche" onchange="saveAndCalc()" class="ios-select w-32"><option value="0">Keine</option><option value="0.08">8%</option><option value="0.09">9%</option></select>
                </div>
            </div>
        </div>
    </main>

    <script>
        const monthNames = ["Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
        const shiftH = { 'F': 7.7, 'S': 7.7, 'N': 10, 'Sp': 8.5, 'U': 7.7, 'X': 0 };
        let userPlan = JSON.parse(localStorage.getItem('springer_v5')) || {};

        function getHolidays(y) {
            const h = {}; const add = (d, m) => h[`${y}-${m}-${d}`] = true;
            add(1,0); add(1,4); add(3,9); add(31,9); add(25,11); add(26,11);
            const a=y%19, b=y%4, c=y%7, d=(19*a+24)%30, e=(2*b+4*c+6*d+5)%7;
            const ost = new Date(y, 2, 22+d+e);
            const addR = (o) => { let x=new Date(ost); x.setDate(ost.getDate()+o); h[`${y}-${x.getMonth()}-${x.getDate()}`]=true; };
            [-2, 0, 1, 39, 49, 50, 60].forEach(addR); return h;
        }

        function init() {
            const ms = document.getElementById('monthSelect'), ys = document.getElementById('yearSelect'), now = new Date();
            monthNames.forEach((n,i) => ms.innerHTML += `<option value="${i}" ${i===now.getMonth()?'selected':''}>${n}</option>`);
            for(let i=now.getFullYear()-1; i<now.getFullYear()+5; i++) ys.innerHTML += `<option value="${i}" ${i===now.getFullYear()?'selected':''}>${i}</option>`;
            
            ['tarif', 'sollstunden', 'h_ue', 'st_klasse', 'kinder', 'kirche'].forEach(id => {
                const v = localStorage.getItem('p_'+id);
                if(v !== null) document.getElementById(id).value = v;
            });
            renderCalendar();
        }

        function switchTab(t) {
            ['plan', 'rechner', 'profil'].forEach(tab => {
                document.getElementById('tab-'+tab).classList.toggle('hidden', tab !== t);
                document.getElementById('btn-'+tab).classList.toggle('active', tab === t);
                document.getElementById('btn-'+tab).classList.toggle('text-gray-400', tab !== t);
            });
        }

        function renderCalendar() {
            const m = parseInt(document.getElementById('monthSelect').value), y = parseInt(document.getElementById('yearSelect').value);
            const container = document.getElementById('calendarContainer'), hols = getHolidays(y);
            container.innerHTML = ''; 
            let date = new Date(y, m, 1);
            
            while (date.getMonth() === m) {
                const d = date.getDate(), key = `${y}-${m}-${d}`, data = userPlan[key] || { type: 'X', hours: 0 };
                const isFt = hols[key], isSo = date.getDay()===0, isSa = date.getDay()===6;
                const row = document.createElement('div');
                row.className = `calendar-grid ${isSo||isFt?'bg-red-500/5':(isSa?'bg-indigo-500/5':'')}`;
                row.innerHTML = `
                    <div class="flex flex-col"><span class="text-[9px] font-black ${isSo||isFt?'text-red-400':(isSa?'text-indigo-400':'opacity-30')}">${date.toLocaleDateString('de-DE',{weekday:'short'}).toUpperCase()}</span><span class="text-sm font-bold">${d}.</span></div>
                    <div class="flex gap-1 justify-center">${['F','S','N','Sp','U','X'].map(t => `<button type="button" onclick="setShift('${key}','${t}')" class="btn-shift ${data.type===t?'active':''}">${t}</button>`).join('')}</div>
                    <div class="text-right"><input type="number" step="0.1" class="hr-edit" value="${data.hours}" onchange="updateHours('${key}', this.value)"></div>`;
                container.appendChild(row); 
                date.setDate(date.getDate() + 1);
            }
            saveAndCalc();
        }

        function setShift(k, t) { 
            userPlan[k] = { type: t, hours: shiftH[t] }; 
            localStorage.setItem('springer_v5', JSON.stringify(userPlan));
            renderCalendar(); 
        }

        function updateHours(k, v) { 
            if(!userPlan[k]) userPlan[k]={type:'X'}; 
            userPlan[k].hours = parseFloat(v)||0; 
            saveAndCalc(); 
        }

        function saveAndCalc() {
            // Speichern
            ['tarif', 'sollstunden', 'h_ue', 'st_klasse', 'kinder', 'kirche'].forEach(id => {
                localStorage.setItem('p_'+id, document.getElementById(id).value);
            });
            localStorage.setItem('springer_v5', JSON.stringify(userPlan));
            
            // Werte holen
            const base = parseFloat(document.getElementById('tarif').value) || 0;
            const soll = parseFloat(document.getElementById('sollstunden').value) || 167;
            const stdLohn = base/soll;
            const stKl = parseInt(document.getElementById('st_klasse').value);
            const kiSt = parseFloat(document.getElementById('kirche').value);
            
            let ist=0, zSo=0, zSa=0, zN=0, zFt=0;
            const m=parseInt(document.getElementById('monthSelect').value);
            const y=parseInt(document.getElementById('yearSelect').value);
            const hols=getHolidays(y);

            // Alle Tage des gew√§hlten Monats durchlaufen
            for (let d=1; d<=31; d++) {
                const k = `${y}-${m}-${d}`; 
                if (userPlan[k]) {
                    const e = userPlan[k];
                    const h = parseFloat(e.hours) || 0;
                    const dt = new Date(y, m, d);
                    
                    if(dt.getMonth() !== m) continue;

                    ist += h;
                    if (e.type !== 'X' && e.type !== 'U' && h > 0) {
                        if (hols[k]) zFt += h; 
                        else if (dt.getDay()===0) zSo += h; 
                        else if (dt.getDay()===6) zSa += h;
                        
                        if (e.type==='N') zN += h;
                    }
                }
            }

            const zTotal = (zFt*stdLohn*1.35) + (zSo*stdLohn*0.5) + (zSa*stdLohn*0.25) + (zN*stdLohn*0.25);
            const ueBrutto = (parseFloat(document.getElementById('h_ue').value)||0)*stdLohn*1.25;
            const brutto = base + ueBrutto;
            
            let stSatz = 0.31; 
            if(stKl === 3) stSatz = 0.21; 
            if(stKl === 5 || stKl === 6) stSatz = 0.43;
            
            const netto = (brutto * (1 - (stSatz + (kiSt * 0.08)))) + zTotal;

            // Anzeige (Sicherheitscheck f√ºr IDs)
            if(document.getElementById('planIst')) document.getElementById('planIst').innerText = ist.toFixed(1) + "h";
            if(document.getElementById('statN')) document.getElementById('statN').innerText = zN.toFixed(1) + "h";
            if(document.getElementById('statSo')) document.getElementById('statSo').innerText = zSo.toFixed(1) + "h";
            if(document.getElementById('statFt')) document.getElementById('statFt').innerText = zFt.toFixed(1) + "h";
            if(document.getElementById('finalNetto')) document.getElementById('finalNetto').innerText = netto.toLocaleString('de-DE',{minimumFractionDigits:2});
            if(document.getElementById('bruttoLabel')) document.getElementById('bruttoLabel').innerText = Math.round(brutto).toLocaleString('de-DE') + " ‚Ç¨";
            if(document.getElementById('taxFreeLabel')) document.getElementById('taxFreeLabel').innerText = Math.round(zTotal).toLocaleString('de-DE') + " ‚Ç¨";
            
            const diff = ist - soll;
            const saldoEl = document.getElementById('planSaldo');
            if(saldoEl) {
                saldoEl.innerText = (diff>=0?'+':'')+diff.toFixed(1)+"h";
                saldoEl.className = `text-[10px] font-bold px-2 py-0.5 rounded-full ${diff>=0?'bg-emerald-500/20 text-emerald-400':'bg-red-500/20 text-red-400'}`;
            }
        }

        function shareWhatsApp() {
            const m = monthNames[document.getElementById('monthSelect').value], y = document.getElementById('yearSelect').value;
            const text = `üìä *LohnCheck Pro*\nüìÖ ${m} ${y}\n\n‚è± Ist: ${document.getElementById('planIst').innerText} / Soll: ${document.getElementById('sollstunden').value}h\nüåô Nacht: ${document.getElementById('statN').innerText}\n‚òÄÔ∏è Sonntag: ${document.getElementById('statSo').innerText}\n\nüí∂ *Netto ca. ${document.getElementById('finalNetto').innerText} ‚Ç¨*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
        window.onload = init;
    </script>
</body>
</html>
